<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Solaire Admin CRM</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root { --primary:#2563eb; --accent:#10b981; --bg:#f3f4f6; --card:#ffffff; --text:#0f172a; }
    * { box-sizing: border-box; }
    body { margin:0; font-family:'Inter',system-ui,sans-serif; background:var(--bg); color:var(--text); }
    header { background:#0f172a; color:#fff; padding:16px 24px; display:flex; justify-content:space-between; align-items:center; position:sticky; top:0; z-index:10; }
    header h1 { margin:0; font-size:20px; }
    main { padding:24px; max-width:1200px; margin:0 auto; }
    .tabs { display:flex; gap:12px; margin-bottom:16px; flex-wrap:wrap; }
    .tab { padding:10px 14px; border-radius:10px; border:1px solid #cbd5e1; background:var(--card); cursor:pointer; font-weight:600; transition:.2s; }
    .tab.active { background:var(--primary); color:#fff; border-color:var(--primary); }
    .grid { display:grid; gap:16px; grid-template-columns: repeat(auto-fit,minmax(320px,1fr)); }
    .card { background:var(--card); border-radius:14px; padding:16px; box-shadow:0 12px 32px rgba(15,23,42,0.06); border:1px solid #e2e8f0; }
    h2 { margin:0 0 12px 0; font-size:18px; }
    form { display:grid; gap:10px; }
    label { font-size:13px; font-weight:600; color:#475569; }
    input, select, textarea { width:100%; padding:10px; border-radius:10px; border:1px solid #cbd5e1; font:inherit; background:#f8fafc; }
    textarea { min-height:70px; }
    button.primary { background:linear-gradient(135deg,var(--primary),#1d4ed8); color:#fff; border:none; border-radius:10px; padding:10px 14px; font-weight:700; cursor:pointer; box-shadow:0 10px 25px rgba(37,99,235,0.35); }
    table { width:100%; border-collapse:collapse; }
    th,td { text-align:left; padding:10px; border-bottom:1px solid #e2e8f0; font-size:14px; }
    th { background:#f8fafc; }
    .badge { padding:4px 8px; border-radius:999px; font-size:12px; font-weight:700; }
    .pill { display:inline-flex; align-items:center; gap:6px; padding:6px 10px; background:#eef2ff; color:#3730a3; border-radius:999px; font-size:13px; }
    .alert { border-left:4px solid var(--accent); padding:10px 12px; background:#ecfdf3; border-radius:10px; color:#065f46; }
    footer { text-align:center; padding:24px; color:#94a3b8; font-size:13px; }
    .auth-overlay { position:fixed; inset:0; background:rgba(15,23,42,0.8); display:flex; align-items:center; justify-content:center; z-index:30; }
    .auth-card { background:#fff; padding:24px; border-radius:14px; width:360px; box-shadow:0 15px 40px rgba(0,0,0,0.2); }
    .hidden { display:none; }
    .kanban { overflow-x:auto; display:flex; gap:12px; padding-bottom:8px; }
    .kanban-col { min-width:240px; background:#f8fafc; border:1px solid #e2e8f0; border-radius:12px; padding:10px; min-height:140px; }
    .kanban-card { margin-bottom:8px; padding:8px; border-radius:10px; background:white; border:1px solid #e2e8f0; cursor:grab; }
  </style>
</head>
<body>
<header>
  <h1>⚡️ Solaire Admin CRM</h1>
  <div id="userInfo" style="font-size:13px; opacity:0.8"></div>
</header>

<div id="auth" class="auth-overlay hidden">
  <div class="auth-card">
    <h2>Connexion</h2>
    <form id="loginForm" style="margin-top:12px; display:grid; gap:10px;">
      <div><label>Email</label><input type="email" name="email" required></div>
      <div><label>Mot de passe</label><input type="password" name="password" required></div>
      <button class="primary" type="submit">Se connecter</button>
      <div style="font-size:12px; color:#475569">Créez le premier compte dans Firebase Auth, puis connectez-vous ici.</div>
    </form>
  </div>
</div>

<main>
  <div class="tabs">
    <div class="tab active" data-tab="leads">Leads</div>
    <div class="tab" data-tab="clients">Clients</div>
    <div class="tab" data-tab="files">Dossiers</div>
  </div>

  <section id="leads" class="tab-pane">
    <div class="grid">
      <div class="card">
        <h2>Créer un lead</h2>
        <form id="leadForm">
          <div><label>Nom complet</label><input name="fullName" required /></div>
          <div><label>Entreprise</label><input name="company" /></div>
          <div><label>Email</label><input name="email" type="email" required /></div>
          <div><label>Téléphone</label><input name="phone" /></div>
          <div><label>Adresse</label><input name="address" /></div>
          <div><label>Site web</label><input name="website" /></div>
          <div><label>Source</label><select name="source"><option>Landing</option><option>Référence</option><option>Appel direct</option><option>LinkedIn</option></select></div>
          <div><label>Priorité</label><select name="priority"><option>Basse</option><option>Moyenne</option><option>Haute</option><option>Urgente</option></select></div>
          <div><label>Nombre de dossiers bloqués</label><select name="blocked_files_count"><option value=\"\">--</option><option>1-5</option><option>6-10</option><option>11-20</option><option>21-50</option><option>50+</option></select></div>
          <div><label>Type de blocage</label><select name="blocking_type"><option value=\"\">--</option><option>Consuel</option><option>Enedis</option><option>EDF OA</option><option>Tout</option></select></div>
          <div><label>Pack souhaité</label><select name="desired_pack"><option value=\"\">--</option><option>Validation</option><option>Mise en service</option><option>Zéro Stress</option></select></div>
          <div class="grid" style="grid-template-columns: repeat(auto-fit,minmax(150px,1fr)); gap:10px;">
            <div><label>Volume mensuel (chantiers)</label><input name="monthly_volume" type="number" min="0" /></div>
            <div><label>CA annuel (€)</label><input name="annual_revenue" type="number" min="0" /></div>
          </div>
          <div><label>Notes</label><textarea name="notes"></textarea></div>
          <button class="primary" type="submit">Ajouter</button>
        </form>
        <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap;">
          <select id="leadStatusFilter">
            <option value="">Filtrer par statut</option>
            <option>Nouveau</option><option>Contacté</option><option>Qualifié</option><option>Devis envoyé</option><option>Gagné</option><option>Perdu</option>
          </select>
          <input id="leadSearch" placeholder="Recherche nom/email" style="flex:1; min-width:180px; padding:10px; border-radius:10px; border:1px solid #cbd5e1; background:#f8fafc;">
          <button id="leadExport" type="button" class="primary" style="padding:10px 12px;">Exporter CSV</button>
        </div>
      </div>
      <div class="card">
        <h2>Kanban Leads</h2>
        <div id="leadKanban" class="kanban"></div>
        <div id="leadList" style="margin-top:12px;"></div>
      </div>
    </div>
  </section>

  <section id="clients" class="tab-pane" style="display:none">
    <div class="grid">
      <div class="card">
        <h2>Nouveau client</h2>
        <form id="clientForm">
          <div><label>Entreprise</label><input name="company" required /></div>
          <div><label>Contact principal</label><input name="contact" required /></div>
          <div class="grid" style="grid-template-columns: repeat(auto-fit,minmax(150px,1fr)); gap:10px;">
            <div><label>Email</label><input name="email" type="email" /></div>
            <div><label>Téléphone</label><input name="phone" /></div>
          </div>
          <div class="grid" style="grid-template-columns: repeat(auto-fit,minmax(150px,1fr)); gap:10px;">
            <div><label>SIRET</label><input name="siret" /></div>
            <div><label>Segment</label><select name="segment"><option>Petit</option><option>Moyen</option><option>Gros</option></select></div>
            <div><label>Statut</label><select name="status"><option>Actif</option><option>Inactif</option><option>VIP</option></select></div>
          </div>
          <div><label>Pack</label><select name="pack"><option>Validation</option><option>Mise en service</option><option>Zéro Stress</option></select></div>
          <div><label>Adresse facturation</label><input name="billing" /></div>
          <div class="grid" style="grid-template-columns: repeat(auto-fit,minmax(150px,1fr)); gap:10px;">
            <div><label>Date début contrat</label><input name="contractStart" type="date" /></div>
            <div><label>Date fin contrat</label><input name="contractEnd" type="date" /></div>
            <div><label>Tarif négocié (€)</label><input name="customRate" type="number" step="0.01" /></div>
            <div><label>Remise (%)</label><input name="discount" type="number" step="0.1" /></div>
            <div><label>Conditions paiement (jours)</label><input name="paymentTerms" type="number" /></div>
          </div>
          <button class="primary" type="submit">Créer</button>
        </form>
      </div>
      <div class="card">
        <h2>Clients</h2>
        <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px;">
          <input id="clientSearch" placeholder="Recherche entreprise/contact" style="flex:1; min-width:180px; padding:10px; border-radius:10px; border:1px solid #cbd5e1; background:#f8fafc;">
          <select id="clientSegmentFilter">
            <option value="">Segment</option><option>Petit</option><option>Moyen</option><option>Gros</option>
          </select>
          <select id="clientStatusFilter">
            <option value="">Statut</option><option>Actif</option><option>Inactif</option><option>VIP</option>
          </select>
          <button id="clientExport" type="button" class="primary" style="padding:10px 12px;">Exporter CSV</button>
        </div>
        <div id="clientList" class="alert">Chargement...</div>
      </div>
      <div class="card">
        <h2>Détails client</h2>
        <div id="clientDetail" class="alert">Sélectionnez un client.</div>
      </div>
    </div>
  </section>

  <section id="files" class="tab-pane" style="display:none">
    <div class="grid">
      <div class="card">
        <h2>Nouveau dossier</h2>
        <form id="fileForm">
          <div><label>Client (texte libre)</label><input name="client" required /></div>
          <div><label>Client final</label><input name="finalClient" required /></div>
          <div><label>Adresse installation</label><input name="address" required /></div>
          <div><label>Pack</label><select name="pack"><option>Validation</option><option>Mise en service</option><option>Zéro Stress</option></select></div>
          <div><label>Statut global</label><select name="status"><option>En attente documents</option><option>En cours</option><option>Bloqué</option><option>Finalisé</option></select></div>
          <div class="grid" style="grid-template-columns: repeat(auto-fit,minmax(150px,1fr)); gap:10px;">
            <div><label>Consuel</label><select name="consuel_status"><option>À faire</option><option>Dossier constitué</option><option>Déposé</option><option>Visite programmée</option><option>Attestation reçue</option></select></div>
            <div><label>Enedis</label><select name="enedis_status"><option>À faire</option><option>Déposé</option><option>Devis reçu</option><option>Travaux programmés</option><option>Mise en service</option></select></div>
            <div><label>EDF OA</label><select name="edfoa_status"><option>Non applicable</option><option>À faire</option><option>Déposé</option><option>En cours d'étude</option><option>Contrat signé</option></select></div>
          </div>
          <div class="grid" style="grid-template-columns: repeat(auto-fit,minmax(150px,1fr)); gap:10px;">
            <div><label>Prix (€)</label><input name="price" type="number" step="0.01" /></div>
            <div><label>Date facturation prévue</label><input name="invoicingDate" type="date" /></div>
          </div>
          <button class="primary" type="submit">Créer</button>
        </form>
      </div>
      <div class="card">
        <h2>Dossiers</h2>
        <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px;">
          <input id="fileSearch" placeholder="Recherche dossier/client" style="flex:1; min-width:180px; padding:10px; border-radius:10px; border:1px solid #cbd5e1; background:#f8fafc;">
          <select id="fileStatusFilter">
            <option value="">Statut</option><option>En attente documents</option><option>En cours</option><option>Bloqué</option><option>Finalisé</option>
          </select>
          <button id="fileExport" type="button" class="primary" style="padding:10px 12px;">Exporter CSV</button>
        </div>
        <div id="fileList" class="alert">Chargement...</div>
      </div>
      <div class="card">
        <h2>Détails dossier</h2>
        <div id="fileDetail" class="alert">Sélectionnez un dossier.</div>
      </div>
    </div>
  </section>
</main>
<footer>Build Firebase Hosting + Firestore • Auth email/password • Déc 2025</footer>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
  import { getFirestore, collection, addDoc, getDocs, serverTimestamp, query, orderBy, limit, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBdQP61dhT8it9_Ua-U8u-xgh40DLnfNbg",
    authDomain: "solaire-admin.firebaseapp.com",
    projectId: "solaire-admin",
    storageBucket: "solaire-admin.firebasestorage.app",
    messagingSenderId: "294963767896",
    appId: "1:294963767896:web:a2f6590fba1de9a0d2782d",
    measurementId: "G-G0WMPNNMWD"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const authOverlay = document.getElementById('auth');
  const userInfo = document.getElementById('userInfo');

  document.getElementById('loginForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const data = Object.fromEntries(new FormData(e.target));
    try { await signInWithEmailAndPassword(auth, data.email, data.password); } catch (err) { alert('Connexion impossible: ' + err.message); }
  });

  onAuthStateChanged(auth, (user) => {
    if (user) {
      authOverlay.classList.add('hidden');
      authOverlay.style.display = 'none';
      userInfo.textContent = `${user.email} — Déconnexion`;
      userInfo.style.cursor = 'pointer';
      userInfo.onclick = () => signOut(auth);
      renderLeads();
      renderClients();
      renderFiles();
    } else {
      authOverlay.classList.remove('hidden');
      authOverlay.style.display = 'flex';
      userInfo.textContent = '';
    }
  });

  const tabs = document.querySelectorAll('.tab');
  const panes = document.querySelectorAll('.tab-pane');
  tabs.forEach(tab => tab.addEventListener('click', () => {
    tabs.forEach(t => t.classList.remove('active'));
    panes.forEach(p => p.style.display = 'none');
    tab.classList.add('active');
    document.getElementById(tab.dataset.tab).style.display = 'block';
  }));

  let leadSnapshot = [];
  let clientSnapshot = [];
  let fileSnapshot = [];

  function renderLeadViews(rows) {
    rows = Array.isArray(rows) ? rows : [];
    const columns = [
      { title: 'Nouveau', key: 'Nouveau' },
      { title: 'Contacté', key: 'Contacté' },
      { title: 'Qualifié', key: 'Qualifié' },
      { title: 'Devis envoyé', key: 'Devis envoyé' },
      { title: 'Gagné', key: 'Gagné' },
      { title: 'Perdu', key: 'Perdu' }
    ];
    const grouped = {};
    columns.forEach(c => grouped[c.key] = []);
    rows.forEach(r => grouped[r.status || 'Nouveau'].push(r));

    const kanban = document.getElementById('leadKanban');
    kanban.innerHTML = '';
    columns.forEach(col => {
      const items = grouped[col.key] || [];
      const card = document.createElement('div');
      card.className = 'kanban-col';
      card.innerHTML = `<div style="font-weight:700;margin-bottom:8px;">${col.title} (${items.length})</div>`;
      if (items.length === 0) {
        const empty = document.createElement('div');
        empty.className = 'alert';
        empty.textContent = 'Aucun lead';
        card.appendChild(empty);
      }
      items.forEach(it => {
        const node = document.createElement('div');
        node.className = 'kanban-card';
        node.innerHTML = `<div style="font-weight:600">${it.fullName || ''}</div>
          <div style="font-size:12px;color:#475569">${it.email || ''}</div>
          <div class="pill" style="margin-top:6px;">${it.priority || ''}</div>
          <div style="font-size:12px;color:#334155;margin-top:4px;">Pack: ${it.desired_pack || '-'} · Blocage: ${it.blocking_type || '-'}</div>
          <div style="margin-top:8px; display:flex; gap:6px; flex-wrap:wrap; align-items:center;">
            <label style="font-size:12px;color:#475569;">Statut</label>
            <select data-id="${it.id}" class="lead-status-select" style="flex:1; min-width:140px; padding:6px 8px; border-radius:8px; border:1px solid #cbd5e1; background:#f8fafc;">
              ${columns.map(c => `<option value="${c.key}" ${c.key === (it.status || 'Nouveau') ? 'selected' : ''}>${c.key}</option>`).join('')}
            </select>
            <button data-id="${it.id}" class="primary lead-convert" style="padding:6px 10px; font-size:12px;">Convertir en client</button>
          </div>`;
        card.appendChild(node);
      });
      kanban.appendChild(card);
    });

    const list = document.getElementById('leadList');
    if (rows.length === 0) { list.innerHTML = '<div class="alert">Aucun lead pour le moment.</div>'; return; }
    let html = '<table><thead><tr><th>Nom</th><th>Source</th><th>Priorité</th><th>Statut</th></tr></thead><tbody>';
    rows.forEach(d => {
      html += `<tr><td>${d.fullName || ''}</td><td>${d.source || ''}</td><td>${d.priority || ''}</td><td><span class="badge status-${(d.status||'new').toLowerCase()}">${d.status || 'Nouveau'}</span></td></tr>`;
    });
    html += '</tbody></table>';
    list.innerHTML = html;
  }

  function applyLeadFilters() {
    if (!Array.isArray(leadSnapshot)) { leadSnapshot = []; }
    const status = document.getElementById('leadStatusFilter').value;
    const q = document.getElementById('leadSearch').value.toLowerCase();
    const filtered = leadSnapshot.filter(l => {
      const okStatus = status ? (l.status === status) : true;
      const okSearch = q ? ((l.fullName || '').toLowerCase().includes(q) || (l.email || '').toLowerCase().includes(q)) : true;
      return okStatus && okSearch;
    });
    renderLeadViews(filtered);
  }

  async function renderLeads() {
    try {
      const snap = await getDocs(query(collection(db, 'leads'), orderBy('createdAt', 'desc'), limit(50)));
      leadSnapshot = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      applyLeadFilters();
    } catch (err) {
      console.error('renderLeads error', err);
      document.getElementById('leadKanban').innerHTML = '<div class=\"alert\">Erreur de chargement des leads. Vérifiez vos droits ou réessayez.</div>';
    }
  }

  function renderClientTable(rows) {
    const list = document.getElementById('clientList');
    if (rows.length === 0) { list.innerHTML = '<div class="alert">Aucun client.</div>'; return; }
    let html = '<table><thead><tr><th>Entreprise</th><th>Contact</th><th>Pack</th><th>Segment</th></tr></thead><tbody>';
    rows.forEach(r => {
      html += `<tr data-id="${r.id}" class="client-row" style="cursor:pointer;"><td>${r.company || ''}</td><td>${r.contact || ''}</td><td>${r.pack || ''}</td><td>${r.segment || ''}</td></tr>`;
    });
    html += '</tbody></table>';
    list.innerHTML = html;
    document.querySelectorAll('.client-row').forEach(row => {
      row.addEventListener('click', async () => {
        const id = row.getAttribute('data-id');
        const snap = await getDoc(doc(db, 'clients', id));
        if (!snap.exists()) return;
        const c = snap.data();
        document.getElementById('clientDetail').innerHTML = `
          <div style="font-weight:700;font-size:16px;">${c.company || ''}</div>
          <div style="margin-top:6px;">Contact: ${c.contact || ''} — ${c.email || ''}</div>
          <div style="margin-top:6px;">Pack: ${c.pack || ''} | Segment: ${c.segment || ''} | Statut: ${c.status || ''}</div>
          <div style="margin-top:6px;">SIRET: ${c.siret || ''}</div>
          <div style="margin-top:6px;">Adresse facturation: ${c.billing || ''}</div>
          <div style="margin-top:6px;">Contrat: ${c.contractStart || ''} → ${c.contractEnd || ''} | Tarif: ${c.customRate || ''}€ | Remise: ${c.discount || ''}% | Paiement: ${c.paymentTerms || ''}j</div>
        `;
      });
    });
  }

  function applyClientFilters() {
    const q = document.getElementById('clientSearch').value.toLowerCase();
    const seg = document.getElementById('clientSegmentFilter').value;
    const st = document.getElementById('clientStatusFilter').value;
    const filtered = clientSnapshot.filter(c => {
      const okQ = q ? ((c.company || '').toLowerCase().includes(q) || (c.contact || '').toLowerCase().includes(q)) : true;
      const okSeg = seg ? c.segment === seg : true;
      const okSt = st ? c.status === st : true;
      return okQ && okSeg && okSt;
    });
    renderClientTable(filtered);
  }

  async function renderClients() {
    const snap = await getDocs(query(collection(db, 'clients'), orderBy('createdAt', 'desc'), limit(50)));
    clientSnapshot = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    applyClientFilters();
  }

  function renderFileTable(rows) {
    const list = document.getElementById('fileList');
    if (rows.length === 0) { list.innerHTML = '<div class="alert">Aucun dossier.</div>'; return; }
    let html = '<table><thead><tr><th>Dossier</th><th>Client</th><th>Pack</th><th>Statut</th></tr></thead><tbody>';
    rows.forEach(r => {
      html += `<tr data-id="${r.id}" class="file-row" style="cursor:pointer;"><td>${r.fileNumber || r.id}</td><td>${r.client || ''}</td><td>${r.pack || ''}</td><td>${r.status || ''}</td></tr>`;
    });
    html += '</tbody></table>';
    list.innerHTML = html;

    document.querySelectorAll('.file-row').forEach(row => {
      row.addEventListener('click', async () => {
        const id = row.getAttribute('data-id');
        const snap = await getDoc(doc(db, 'files', id));
        if (!snap.exists()) return;
        const f = snap.data();
        document.getElementById('fileDetail').innerHTML = `
          <div style="font-weight:700;font-size:16px;">${f.fileNumber || id}</div>
          <div style="margin-top:6px;">Client: ${f.client || ''} | Pack: ${f.pack || ''} | Statut: ${f.status || ''}</div>
          <div style="margin-top:6px;">Consuel: ${f.consuel_status || ''} | Enedis: ${f.enedis_status || ''} | EDF OA: ${f.edfoa_status || ''}</div>
          <div style="margin-top:6px;">Adresse: ${f.address || ''}</div>
          <div style="margin-top:6px;">Client final: ${f.finalClient || ''}</div>
          <div style="margin-top:6px;">Prix: ${f.price || ''}€ | Facturation prévue: ${f.invoicingDate || ''}</div>
        `;
      });
    });
  }

  function applyFileFilters() {
    const q = document.getElementById('fileSearch').value.toLowerCase();
    const st = document.getElementById('fileStatusFilter').value;
    const filtered = fileSnapshot.filter(f => {
      const okQ = q ? ((f.fileNumber || '').toLowerCase().includes(q) || (f.client || '').toLowerCase().includes(q)) : true;
      const okSt = st ? f.status === st : true;
      return okQ && okSt;
    });
    renderFileTable(filtered);
  }

  async function renderFiles() {
    const snap = await getDocs(query(collection(db, 'files'), orderBy('createdAt', 'desc'), limit(50)));
    fileSnapshot = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    applyFileFilters();
  }

  document.getElementById('leadForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const data = Object.fromEntries(new FormData(e.target));
    await addDoc(collection(db, 'leads'), { ...data, status: 'Nouveau', createdAt: serverTimestamp() });
    e.target.reset();
    renderLeads();
    alert('Lead créé');
  });

  document.getElementById('clientForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const data = Object.fromEntries(new FormData(e.target));
    await addDoc(collection(db, 'clients'), { ...data, createdAt: serverTimestamp() });
    e.target.reset();
    renderClients();
    alert('Client créé');
  });

  document.getElementById('fileForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const data = Object.fromEntries(new FormData(e.target));
    const seq = Math.floor(Date.now() / 1000);
    const fileNumber = `DOS-${new Date().getFullYear()}-${String(seq).slice(-4)}`;
    await addDoc(collection(db, 'files'), { ...data, fileNumber, createdAt: serverTimestamp() });
    e.target.reset();
    renderFiles();
    alert('Dossier créé');
  });

  document.getElementById('leadStatusFilter').addEventListener('change', applyLeadFilters);
  document.getElementById('leadSearch').addEventListener('input', applyLeadFilters);
  document.getElementById('leadExport').addEventListener('click', () => exportCSV(leadSnapshot, ['fullName','email','phone','source','priority','status']));

  document.getElementById('clientSearch').addEventListener('input', applyClientFilters);
  document.getElementById('clientSegmentFilter').addEventListener('change', applyClientFilters);
  document.getElementById('clientStatusFilter').addEventListener('change', applyClientFilters);
  document.getElementById('clientExport').addEventListener('click', () => exportCSV(clientSnapshot, ['company','contact','email','phone','pack','segment','status','siret','billing']));

  document.getElementById('fileSearch').addEventListener('input', applyFileFilters);
  document.getElementById('fileStatusFilter').addEventListener('change', applyFileFilters);
  document.getElementById('fileExport').addEventListener('click', () => exportCSV(fileSnapshot, ['fileNumber','client','finalClient','pack','status','consuel_status','enedis_status','edfoa_status','price','invoicingDate']));

  function exportCSV(rows, fields) {
    if (!rows || rows.length === 0) return alert('Rien à exporter');
    const header = fields.join(',');
    const body = rows.map(r => fields.map(f => `"${(r[f]||'').toString().replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob = new Blob([header + '\n' + body], { type:'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'export.csv'; a.click(); URL.revokeObjectURL(url);
  }

  // Inline status change + convert lead
  document.addEventListener('change', async (e) => {
    if (e.target.classList.contains('lead-status-select')) {
      const id = e.target.getAttribute('data-id');
      const value = e.target.value;
      await updateDoc(doc(db, 'leads', id), { status: value, updatedAt: serverTimestamp() });
      renderLeads();
    }
  });

  document.addEventListener('click', async (e) => {
    if (e.target.classList.contains('lead-convert')) {
      const id = e.target.getAttribute('data-id');
      const lead = leadSnapshot.find(l => l.id === id);
      if (!lead) return;
      // Mapping rapide selon le prompt
      const segment = (() => {
        const val = (lead.blocked_files_count || '').replace(/[^0-9+]/g,'');
        if (!val) return 'Petit';
        if (val.includes('+') || parseInt(val,10) > 10) return 'Gros';
        if (parseInt(val,10) >= 6) return 'Moyen';
        return 'Petit';
      })();
      await addDoc(collection(db, 'clients'), {
        company: lead.company || lead.fullName || '',
        legal_name: lead.company || lead.fullName || '',
        contact: lead.fullName || '',
        email: lead.email || '',
        phone: lead.phone || '',
        pack: lead.desired_pack || lead.priority || '',
        segment,
        status: 'Actif',
        billing: lead.address || '',
        contractStart: '',
        contractEnd: '',
        customRate: '',
        discount: lead.discount || '',
        paymentTerms: 30,
        siret: lead.siret || '',
        annual_revenue: lead.annual_revenue || '',
        createdAt: serverTimestamp()
      });
      // Créer un dossier initial
      const seq = Math.floor(Date.now() / 1000);
      const fileNumber = `DOS-${new Date().getFullYear()}-${String(seq).slice(-4)}`;
      await addDoc(collection(db, 'files'), {
        fileNumber,
        client: lead.company || lead.fullName || '',
        finalClient: lead.fullName || '',
        address: lead.address || '',
        pack: lead.desired_pack || 'Validation',
        status: 'En attente documents',
        consuel_status: 'À faire',
        enedis_status: 'À faire',
        edfoa_status: 'Non applicable',
        price: '',
        invoicingDate: '',
        createdAt: serverTimestamp()
      });
      await updateDoc(doc(db, 'leads', id), { status: 'Converti', client_id_created: true, updatedAt: serverTimestamp() });
      renderLeads();
      renderClients();
      renderFiles();
      alert('Lead converti en client.');
    }
  });
</script>
</body>
</html>
